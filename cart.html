<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KOALAW | سبد خرید (SPA)</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <style>
    @import url("https://font-face.ir/css/iransans/");

    :root{
      --primary:#e39ab4;
      --secondary:#1a1a1a;
      --accent:#ffe9f2;
      --rose-gold:#f0b7c4;
      --rose-cream:#e3d1d6;
      --cream:#faf8f3;
      --deep-brown:#3d2914;
      --blush:#ffd7e5;
      --lavender:#eae2ff;
      --mint:#dff8ef;
      --butter:#fff3bf;
    }

    *{margin:0;padding:0;box-sizing:border-box;cursor:none !important}
    body{font-family:"IRANSans",sans-serif;font-size:15px;background-color:var(--cream);color:#333;overflow-x:hidden;cursor:none}
    .font-serif{font-family:"IRANSans",serif}

    body.mobile-menu-open, body.search-overlay-open{overflow:hidden}

    .mobile-menu-overlay{position:fixed;inset:0;background-color:rgba(0,0,0,.6);z-index:55;opacity:0;visibility:hidden;transition:opacity .4s ease, visibility .4s ease}
    .mobile-menu-overlay.is-active{opacity:1;visibility:visible}

    #mobile-menu{position:fixed;top:0;right:0;width:80%;max-width:320px;height:100%;background-color:var(--cream);box-shadow:-10px 0 30px rgba(0,0,0,.1);z-index:60;transform:translateX(100%);transition:transform .4s cubic-bezier(.23,1,.32,1);display:flex;flex-direction:column;padding:6rem 2rem 2rem;align-items:flex-end;gap:1.25rem;direction:ltr;text-align:right}
    #mobile-menu.is-active{transform:translateX(0)}
    #mobile-menu .nav-link{font-size:1.15rem;font-weight:700;color:var(--deep-brown);width:100%}

    .hamburger-button{width:40px;height:40px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;position:relative;z-index:65;background:0 0;border:none}
    .hamburger-button span{display:block;width:24px;height:2px;background-color:var(--deep-brown);border-radius:2px;transition:transform .3s ease-in-out, opacity .3s ease-in-out;transform-origin:center}
    .hamburger-button.is-active span:nth-child(1){transform:translateY(7px) rotate(45deg)}
    .hamburger-button.is-active span:nth-child(2){opacity:0;transform:scaleX(0)}
    .hamburger-button.is-active span:nth-child(3){transform:translateY(-7px) rotate(-45deg)}

    nav{backdrop-filter:blur(20px);background:rgba(250,248,243,.85);box-shadow:0 1px 20px rgba(0,0,0,.05)}
    .nav-link{position:relative;font-weight:500;letter-spacing:.5px;transition:all .3s ease}
    .nav-link::before{content:"";position:absolute;bottom:-5px;right:0;width:0;height:2px;background:linear-gradient(90deg,var(--primary),var(--rose-gold));transition:width .3s ease}
    .nav-link:hover::before{width:100%}

    /* Cursor (exact design) */
    .cursor{width:30px;height:30px;border:2px solid #666;background:transparent;border-radius:50% 50% 45% 45%;position:fixed;pointer-events:none;z-index:9999;transform:translate(-50%,-50%);transition:border-color .2s ease, transform .2s ease}
    .cursor::before,.cursor::after{content:"";position:absolute;width:12px;height:12px;border:2px solid #666;background:transparent;border-radius:50%;top:-3px;transition:border-color .2s ease}
    .cursor::before{right:-9px}
    .cursor::after{left:-9px}
    .cursor-face{position:fixed;width:30px;height:30px;pointer-events:none;z-index:10000;transform:translate(-50%,-50%)}
    .cursor-face::before{content:"";position:absolute;width:4px;height:7px;border:1.5px solid #333;background:transparent;border-radius:50%;top:13px;left:50%;transform:translateX(-50%)}
    .cursor-eyes{position:absolute;width:100%;height:100%;top:0;left:0}
    .cursor-eyes::before,.cursor-eyes::after{content:"";position:absolute;width:3px;height:3px;border:2px solid #333;background:transparent;border-radius:50%;top:10px}
    .cursor-eyes::before{right:6px}
    .cursor-eyes::after{left:6px}
    .cursor.hover{border-color:var(--primary);transform:translate(-50%,-50%) scale(1.2)}
    .cursor.hover::before,.cursor.hover::after{border-color:var(--primary)}
    .cursor-follower{width:50px;height:50px;background:rgba(227,154,180,.1);border-radius:50%;position:fixed;pointer-events:none;z-index:9998;transform:translate(-50%,-50%);transition:background .3s ease, transform .3s ease}

    /* Floating heart (exact design) */
    .floating-heart{position:fixed;left:0;top:0;transform:translate(-50%,-50%);font-size:16px;pointer-events:none;z-index:10000;opacity:0;animation:heartFloat 1.2s ease-out forwards;filter:drop-shadow(0 2px 0 rgba(0,0,0,.02))}
    @keyframes heartFloat{0%{transform:translate(-50%,-50%) scale(.8);opacity:0}15%{opacity:.95}60%{transform:translate(-50%,-140%) scale(1.15)}100%{transform:translate(-50%,-200%) scale(1);opacity:0}}
    @media (prefers-reduced-motion:reduce){.floating-heart{animation:none !important}}

    /* Hero */
    .profile-hero{background:linear-gradient(135deg,var(--primary) 0%,var(--rose-gold) 100%);position:relative;overflow:hidden}
    .profile-hero::before{content:"";position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 70%);animation:rotate 30s linear infinite}
    @keyframes rotate{from{transform:rotate(0)}to{transform:rotate(360deg)}}

    .profile-card{background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border-radius:30px;padding:2rem;box-shadow:0 20px 40px rgba(0,0,0,.1);transition:all .4s cubic-bezier(.175,.885,.32,1.275);border:1px solid rgba(227,154,180,.2)}
    .order-card{background:#fff;border-radius:20px;padding:1.25rem;border:1px solid rgba(227,154,180,.1);transition:all .4s ease}
    .order-card:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(120,80,100,.1);border-color:var(--primary)}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--rose-gold));color:#fff;padding:.75rem 1.5rem;border-radius:25px;border:none;font-weight:600;transition:.3s;display:inline-flex;align-items:center;justify-content:center;gap:.5rem}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(227,154,180,.4)}
    .btn-secondary{background:transparent;color:var(--deep-brown);border:2px solid rgba(227,154,180,.3);padding:.75rem 1.5rem;border-radius:25px;font-weight:600;transition:.3s;display:inline-flex;align-items:center;justify-content:center;gap:.5rem}
    .btn-secondary:hover{background:var(--primary);color:#fff;border-color:var(--primary)}

    /* Search Overlay (reference) */
    .search-overlay{position:fixed;inset:0;background-color:rgba(250,248,243,.8);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);z-index:999;display:flex;justify-content:center;align-items:flex-start;padding:15vh 5% 0;opacity:0;visibility:hidden;transition:opacity .4s ease, visibility .4s ease}
    .search-overlay.is-active{opacity:1;visibility:visible}
    .search-container{position:relative;width:100%;max-width:600px;padding:20px;transform:translateY(-20px);transition:transform .4s cubic-bezier(.23,1,.32,1)}
    .search-overlay.is-active .search-container{transform:translateY(0)}
    .close-search-button{position:absolute;top:-10vh;right:0;color:var(--deep-brown);background:none;border:none;padding:10px;transform:scale(1.2)}
    .close-search-button:hover{color:var(--primary)}
    .search-form{position:relative;width:100%}
    .search-input{width:100%;border:2px solid rgba(61,41,20,.2);border-radius:50px;background-color:rgba(255,255,255,.7);color:var(--deep-brown);transition:all .3s ease;outline:none;padding:1rem 1.25rem 1rem 3.5rem;font-size:1rem}
    .search-input:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(227,154,180,.3)}
    .search-submit-button{position:absolute;top:50%;transform:translateY(-50%);border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--rose-gold));color:#fff;border:none;display:flex;align-items:center;justify-content:center;width:40px;height:40px;left:6px}
    .search-submit-button:hover{transform:translateY(-50%) scale(1.1)}
    .search-suggestions{margin-top:1rem;text-align:center;color:var(--deep-brown);display:flex;justify-content:center;align-items:center;gap:.5rem;flex-wrap:wrap}
    .search-suggestions a{display:inline-block;background-color:rgba(227,154,180,.1);border:1px solid rgba(227,154,180,.2);border-radius:20px;color:var(--deep-brown);transition:all .3s ease;text-decoration:none;padding:.4rem .8rem;font-size:.8rem}
    .search-suggestions a:hover{background-color:var(--primary);color:#fff;border-color:var(--primary);transform:translateY(-2px)}

    /* Toggle switch (reference) */
    .toggle-switch{position:relative}
    .toggle-switch input{position:absolute;opacity:0;width:1px;height:1px}
    .toggle-switch .switch{width:44px;height:24px;background:#e5e7eb;border-radius:9999px;display:inline-block;position:relative;transition:background .25s ease, box-shadow .25s ease;box-shadow:inset 0 0 0 1px rgba(61,41,20,.08)}
    .toggle-switch .switch::after{content:"";position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:transform .25s ease;box-shadow:0 1px 2px rgba(0,0,0,.12)}
    .toggle-switch input:checked + .switch{background:var(--primary);box-shadow:inset 0 0 0 2px rgba(227,154,180,.35)}
    .toggle-switch input:checked + .switch::after{transform:translateX(20px)}
    .toggle-switch input:focus-visible + .switch{outline:none;box-shadow:0 0 0 4px rgba(227,154,180,.3)}

    .progress-rail{height:10px;border-radius:9999px;background:rgba(227,154,180,.2);overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--rose-gold));width:0%}
    .qty-box{display:flex;align-items:center;gap:.4rem;border:1px solid rgba(227,154,180,.25);background:#fff;border-radius:14px;padding:.25rem .4rem}
    .qty-btn{width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#f8fafc;border:1px solid rgba(0,0,0,.06)}
    .qty-input{width:52px;text-align:center;border:none;outline:none;background:transparent;font-weight:700}
    .badge-free{background:var(--mint);color:#065f46}
    .badge-warn{background:var(--butter);color:#92400e}

    /* Checkout stepper (responsive) */
    .checkout-steps{
      --dot-size: clamp(26px, 6vw, 34px);
      --line-w: clamp(28px, 8vw, 56px);
      --gap: clamp(.5rem, 2vw, .75rem);
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap: var(--gap);
      width:100%;
      padding:.25rem 0;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x proximity;
      flex-wrap: nowrap;
      touch-action: pan-x;
    }
    .checkout-steps .step,
    .checkout-steps .step-line{
      flex:0 0 auto;
      scroll-snap-align: center;
    }
    .checkout-steps .step{
      display:flex;
      align-items:center;
      gap:.5rem;
      text-decoration:none;
      color:var(--deep-brown);
      font-weight:700;
      white-space:nowrap;
      transition:opacity .25s ease;
    }
    .checkout-steps .step[aria-disabled="true"]{opacity:.6;pointer-events:none}
    .step-dot{
      width:var(--dot-size);
      height:var(--dot-size);
      border-radius:9999px;
      background:#fff;
      border:2px solid rgba(227,154,180,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#7a5843;
      font-weight:900;
      box-shadow:0 4px 12px rgba(227,154,180,.25)
    }
    .step-label{ font-size: clamp(.82rem, 2.4vw, .95rem) }
    .step-line{
      width:var(--line-w);
      height:2px;
      background:rgba(227,154,180,.35);
      border-radius:99px
    }
    .step.is-current .step-dot{
      border-color:var(--primary);
      color:var(--primary);
      box-shadow:0 0 0 4px rgba(227,154,180,.25)
    }
    .step.is-done .step-dot{
      background:linear-gradient(135deg,var(--primary),var(--rose-gold));
      border-color:transparent;
      color:#fff;
      position:relative
    }
    .step.is-done .step-dot::after{content:"✓";font-size:.95rem;font-weight:900}
    .step.is-done ~ .step-line,
    .step.is-current + .step-line{
      background:linear-gradient(90deg,var(--primary),var(--rose-gold))
    }
    @media (min-width:640px){
      .checkout-steps{
        justify-content:center;
        flex-wrap:wrap;
        overflow:visible;
        scroll-snap-type:none;
      }
      .checkout-steps .step{ white-space:normal }
    }
    .checkout-steps::-webkit-scrollbar{ height:6px }
    .checkout-steps::-webkit-scrollbar-thumb{ background:rgba(227,154,180,.35); border-radius:9999px }
    @media (max-width:639px){
      .checkout-steps{ scrollbar-width:thin }
    }

    /* Toast */
    .toast{position:fixed;bottom:24px;left:24px;z-index:90;background:#111827;color:#fff;border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);opacity:0;transform:translateY(10px);transition:all .3s ease}
    .toast.show{opacity:1;transform:translateY(0)}

    /* Pulse for cart badge */
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
    .pulse-animation{animation:pulse 1.8s ease-in-out infinite}

    /* Responsive tweaks */
    @media (pointer:coarse){*{cursor:auto !important}}
    @media (min-width:768px){
      .search-overlay{align-items:center;padding:0 5%}
      .close-search-button{top:-50px;right:-10px;transform:scale(1)}
      .search-input{padding:1.25rem 1.5rem 1.25rem 4rem;font-size:1.1rem}
      .search-submit-button{width:48px;height:48px;left:8px}
    }
  </style>
</head>

<body>
  <!-- Custom cursor -->
  <div class="cursor"><div class="cursor-eyes"></div></div>
  <div class="cursor-face"></div>
  <div class="cursor-follower"></div>

  <!-- Navbar -->
  <nav class="fixed w-full z-50 transition-all duration-300" id="navbar">
    <div class="container mx-auto px-6 py-5">
      <div class="flex items-center justify-between" dir="ltr">
        <a href="#/cart" class="text-3xl font-serif font-bold text-gray-800 tracking-wider z-50 flex items-center gap-x-1">K<img src="./image/koala.png" alt="Koala logo" class="w-8 h-7 inline-block -mt-1">ALAW</a>
        <div class="hidden lg:flex items-center gap-x-10 flex-row-reverse">
          <a href="/shop" class="nav-link text-gray-700 hover:text-gray-900 transition duration-300">فروشگاه</a>
          <a href="/#collections" class="nav-link text-gray-700 hover:text-gray-900 transition duration-300">کالکشن ها</a>
          <a href="/#brands" class="nav-link text-gray-700 hover:text-gray-900 transition duration-300">برندها</a>
          <a href="/#magazine" class="nav-link text-gray-700 hover:text-gray-900 transition duration-300">مجله</a>
          <a href="/#about" class="nav-link text-gray-700 hover:text-gray-900 transition duration-300">درباره ما</a>
        </div>
        <div class="flex items-center gap-x-6">
          <button id="search-button" class="text-gray-700 hover:text-gray-900 transition-all duration-300 hover:scale-110">
            <i data-feather="search" class="w-5 h-5"></i>
          </button>
          <button class="text-gray-700 hover:text-gray-900 transition-all duration-300 hover:scale-110">
            <i data-feather="user" class="w-5 h-5"></i>
          </button>
          <a href="#/cart" class="text-gray-700 hover:text-gray-900 relative transition-all duration-300 hover:scale-110">
            <i data-feather="shopping-bag" class="w-5 h-5"></i>
            <span id="nav-cart-count" class="absolute -top-2 -right-2 bg-gradient-to-r from-rose-500 to-pink-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center pulse-animation">۰</span>
          </a>
          <button id="mobile-menu-button" class="hamburger-button lg:hidden"><span></span><span></span><span></span></button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Mobile Menu -->
  <div id="mobile-menu">
    <a href="/shop" class="nav-link">فروشگاه</a>
    <a href="/#collections" class="nav-link">کالکشن ها</a>
    <a href="/#brands" class="nav-link">برندها</a>
    <a href="/#magazine" class="nav-link">مجله</a>
    <a href="/#about" class="nav-link">درباره ما</a>
  </div>
  <div id="mobile-menu-overlay" class="mobile-menu-overlay"></div>

  <!-- Hero -->
  <section class="profile-hero pt-24 pb-16 relative" id="hero-section">
    <div class="container mx-auto px-6 relative z-10">
      <div class="text-center text-white" data-aos="fade-up">
        <div class="inline-flex items-center gap-3 bg-white/20 backdrop-blur-sm rounded-full px-6 py-2 mb-6">
          <i id="hero-icon" data-feather="shopping-bag" class="w-5 h-5"></i>
          <span id="hero-badge" class="font-medium">سبد خرید</span>
        </div>
        <h1 id="hero-title" class="text-4xl lg:text-5xl font-serif font-bold mb-3">سفارش خود را نهایی کنید</h1>
        <p id="hero-subtitle" class="text-lg text-white/90 max-w-2xl mx-auto">بررسی اقلام سبد، اعمال کد تخفیف و ادامه به پرداخت</p>
      </div>
    </div>
  </section>

  <!-- Checkout steps -->
  <section class="pb-4">
    <div class="container mx-auto px-6">
      <div class="profile-card">
        <div class="checkout-steps" role="list" aria-label="مراحل خرید">
          <a href="#/cart" class="step" id="step-cart" role="listitem">
            <span class="step-dot"><span class="step-index">۱</span></span>
            <span class="step-label">سبد خرید</span>
          </a>
          <span class="step-line"></span>
          <a href="#/address" class="step" id="step-address" role="listitem">
            <span class="step-dot"><span class="step-index">۲</span></span>
            <span class="step-label">آدرس و ارسال</span>
          </a>
          <span class="step-line"></span>
          <a href="#/payment" class="step" id="step-payment" role="listitem">
            <span class="step-dot"><span class="step-index">۳</span></span>
            <span class="step-label">پرداخت</span>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Views -->
  <main class="py-12">
    <div class="container mx-auto px-6">

      <!-- Cart View -->
      <section id="view-cart" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left -->
        <div class="lg:col-span-2 space-y-6" data-aos="fade-up">
          <!-- Free shipping progress -->
          <div class="profile-card">
            <div class="flex items-center justify-between gap-3 flex-wrap mb-3">
              <div class="flex items-center gap-2 text-gray-800">
                <i data-feather="truck"></i>
                <p id="cart-progress-text" class="font-semibold">برای ارسال رایگان، هنوز ۰ تومان مانده است.</p>
              </div>
              <span id="cart-ship-badge" class="text-xs px-3 py-1 rounded-full badge-warn">فعال‌سازی ارسال رایگان</span>
            </div>
            <div class="progress-rail"><div id="cart-progress-bar" class="progress-fill"></div></div>
          </div>

          <!-- Items -->
          <div id="cart-items" class="space-y-4"></div>

          <!-- Empty -->
          <div id="cart-empty" class="hidden">
            <div class="profile-card text-center">
              <div class="mx-auto w-16 h-16 rounded-2xl bg-white/70 text-rose-600 flex items-center justify-center mb-4">
                <i data-feather="shopping-bag"></i>
              </div>
              <h3 class="text-lg font-bold text-gray-800 mb-2">سبد خرید شما خالی است</h3>
              <p class="text-gray-600 mb-6">به نظر می‌رسد هنوز محصولی اضافه نکرده‌اید.</p>
              <a href="/shop" class="btn-primary">
                <i data-feather="arrow-right"></i>
                شروع خرید
              </a>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex flex-col sm:flex-row gap-3 justify-between">
            <a href="/shop" class="btn-secondary">
              <i data-feather="arrow-right"></i>
              ادامه خرید
            </a>
            <button id="cart-clear" class="btn-secondary text-rose-700 border-rose-300">
              <i data-feather="trash-2"></i>
              پاک کردن سبد
            </button>
          </div>

          <!-- Recommendations (Desktop only under items) -->
          <div class="profile-card hidden lg:block" data-aos="fade-up" data-aos-delay="50">
            <h3 class="font-bold text-gray-800 mb-4">شاید این‌ها را هم بپسندید</h3>
            <div id="cart-recommendations-desktop" class="grid grid-cols-3 xl:grid-cols-4 gap-4"></div>
          </div>
        </div>

        <!-- Right Summary -->
        <aside class="space-y-6" data-aos="fade-up" data-aos-delay="100">
          <div class="profile-card">
            <h3 class="text-xl font-bold text-gray-800 mb-5">خلاصه سفارش</h3>

            <!-- Coupon -->
            <div class="mb-4">
              <label class="block font-semibold mb-2 text-gray-800">کد تخفیف</label>
              <div class="flex gap-2">
                <input id="cart-coupon-code" dir="ltr" type="text" placeholder="مثلا: KOALAW10" class="form-input flex-1">
                <button id="cart-apply-coupon" class="btn-primary">اعمال</button>
              </div>
              <p id="cart-coupon-msg" class="text-sm text-gray-500 mt-2"></p>
            </div>

            <!-- Options -->
            <div class="space-y-4 border-t pt-4">
              <div class="flex items-center justify-between">
                <div>
                  <p class="font-semibold text-gray-800">بسته‌بندی هدیه</p>
                  <p class="text-xs text-gray-500">جعبه شیک + کارت دست‌نویس</p>
                </div>
                <label class="toggle-switch">
                  <input id="cart-gift-wrap" type="checkbox">
                  <span class="switch"></span>
                </label>
              </div>
              <div class="flex items-center justify-between">
                <div>
                  <p class="font-semibold text-gray-800">ارسال اکسپرس</p>
                  <p class="text-xs text-gray-500">تحویل سریع‌تر در شهرهای منتخب</p>
                </div>
                <label class="toggle-switch">
                  <input id="cart-express" type="checkbox">
                  <span class="switch"></span>
                </label>
              </div>
              <div class="text-xs text-gray-500">
                هزینه‌ها: بسته‌بندی +۲۰,۰۰۰ | اکسپرس +۳۰,۰۰۰ (تومان)
              </div>
            </div>

            <!-- Notes -->
            <div class="mt-4">
              <label class="block font-semibold mb-2 text-gray-800">یادداشت سفارش (اختیاری)</label>
              <textarea id="cart-note" rows="3" class="form-input" placeholder="اگر نکته‌ای هست اینجا بنویسید..."></textarea>
            </div>

            <!-- Totals -->
            <div class="mt-6 space-y-3 text-sm">
              <div class="flex items-center justify-between">
                <span class="text-gray-600">جمع جزء</span>
                <span id="cart-subtotal" class="font-bold text-gray-800">۰ تومان</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-gray-600">تخفیف</span>
                <span id="cart-discount" class="font-bold text-rose-700">۰ تومان</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-gray-600">هزینه ارسال</span>
                <span id="cart-shipping" class="font-bold text-gray-800">۰ تومان</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-gray-600">بسته‌بندی هدیه</span>
                <span id="cart-gift" class="font-bold text-gray-800">۰ تومان</span>
              </div>
              <div class="border-t pt-3 flex items-center justify-between text-base">
                <span class="font-extrabold text-gray-900">مبلغ قابل پرداخت</span>
                <span id="cart-grand" class="font-extrabold text-gray-900">۰ تومان</span>
              </div>
            </div>

            <button id="cart-checkout-btn" class="w-full mt-6 btn-primary">
              ادامه به مرحله بعد (آدرس و ارسال)
            </button>
            <p class="text-xs text-gray-500 mt-3">با ادامه، شرایط و قوانین را می‌پذیرید.</p>
          </div>

          <!-- Recommendations (Mobile & Tablet in sidebar) -->
          <div class="profile-card lg:hidden">
            <h3 class="font-bold text-gray-800 mb-4">شاید این‌ها را هم بپسندید</h3>
            <div id="cart-recommendations" class="grid grid-cols-2 gap-3"></div>
          </div>
        </aside>
      </section>

      <!-- Address View -->
      <section id="view-address" class="grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">
        <!-- Left -->
        <div class="lg:col-span-2 space-y-6" data-aos="fade-up">
          <div class="profile-card">
            <h3 class="text-xl font-bold text-gray-800 mb-5">اطلاعات گیرنده</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="form-label">نام</label>
                <input id="addr-firstname" type="text" class="form-input" placeholder="مانند: سارا">
              </div>
              <div>
                <label class="form-label">نام خانوادگی</label>
                <input id="addr-lastname" type="text" class="form-input" placeholder="مانند: محمدی">
              </div>
              <div>
                <label class="form-label">شماره موبایل</label>
                <input id="addr-phone" type="tel" dir="ltr" class="form-input" placeholder="09xxxxxxxxx">
              </div>
              <div>
                <label class="form-label">کد پستی</label>
                <input id="addr-postal" type="text" dir="ltr" maxlength="10" class="form-input" placeholder="xxxxxxxxxx">
              </div>
              <div>
                <label class="form-label">استان</label>
                <input id="addr-province" type="text" class="form-input" placeholder="استان">
              </div>
              <div>
                <label class="form-label">شهر</label>
                <input id="addr-city" type="text" class="form-input" placeholder="شهر">
              </div>
            </div>
            <div class="mt-4">
              <label class="form-label">نشانی کامل</label>
              <textarea id="addr-line1" rows="3" class="form-input" placeholder="آدرس دقیق تحویل"></textarea>
            </div>
          </div>

          <div class="profile-card">
            <h3 class="text-xl font-bold text-gray-800 mb-5">روش ارسال</h3>
            <div class="space-y-3" id="addr-ship-methods">
              <label class="flex items-center justify-between gap-4 p-3 rounded-2xl border border-gray-200 hover:border-primary transition">
                <div class="flex items-center gap-3">
                  <input type="radio" name="addr-ship" id="addr-ship-standard" value="standard" class="accent-rose-500">
                  <div>
                    <p class="font-semibold text-gray-800">استاندارد</p>
                    <p class="text-xs text-gray-500">تحویل ۲-۴ روز کاری</p>
                  </div>
                </div>
                <span id="addr-price-standard" class="font-bold text-gray-800">۴۵,۰۰۰ تومان</span>
              </label>

              <label class="flex items-center justify-between gap-4 p-3 rounded-2xl border border-gray-200 hover:border-primary transition">
                <div class="flex items-center gap-3">
                  <input type="radio" name="addr-ship" id="addr-ship-express" value="express" class="accent-rose-500">
                  <div>
                    <p class="font-semibold text-gray-800">اکسپرس</p>
                    <p class="text-xs text-gray-500">تحویل سریع‌تر در شهرهای منتخب</p>
                  </div>
                </div>
                <span id="addr-price-express" class="font-bold text-gray-800">۷۵,۰۰۰ تومان</span>
              </label>
            </div>
          </div>

          <div class="flex gap-3">
            <a href="#/cart" class="btn-secondary">
              <i data-feather="arrow-right"></i>
              بازگشت به سبد
            </a>
            <button id="addr-to-payment" class="btn-primary">
              ادامه به پرداخت
              <i data-feather="arrow-left"></i>
            </button>
          </div>
        </div>

        <!-- Summary -->
        <aside class="space-y-6" data-aos="fade-up" data-aos-delay="100">
          <div class="profile-card">
            <h3 class="text-xl font-bold text-gray-800 mb-5">خلاصه سفارش</h3>
            <div class="mt-2 space-y-3 text-sm">
              <div class="flex items-center justify-between">
                <span class="text-gray-600">جمع جزء</span>
                <span id="addr-subtotal" class="font-bold text-gray-800">۰ تومان</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-gray-600">تخفیف</span>
                <span id="addr-discount" class="font-bold text-rose-700">۰ تومان</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-gray-600">هزینه ارسال</span>
                <span id="addr-shipping" class="font-bold text-gray-800">۰ تومان</span>
              </div>
              <div class="border-t pt-3 flex items-center justify-between text-base">
                <span class="font-extrabold text-gray-900">مبلغ قابل پرداخت</span>
                <span id="addr-grand" class="font-extrabold text-gray-900">۰ تومان</span>
              </div>
            </div>
          </div>

          <div class="profile-card">
            <h4 class="font-bold text-gray-800 mb-3">ارسال به:</h4>
            <p id="addr-ship-to" class="text-sm text-gray-600 leading-7">—</p>
          </div>
        </aside>
      </section>

      <!-- Payment View -->
      <section id="view-payment" class="grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">
        <!-- Left -->
        <div class="lg:col-span-2 space-y-6" data-aos="fade-up">
          <div class="profile-card">
            <h3 class="text-xl font-bold text-gray-800 mb-5">روش پرداخت</h3>
            <div class="space-y-3" id="pay-methods">
              <label class="flex items-center justify-between gap-4 p-3 rounded-2xl border border-gray-200 hover:border-primary transition">
                <div class="flex items-center gap-3">
                  <input type="radio" name="pay-method" value="gateway" class="accent-rose-500" checked>
                  <div>
                    <p class="font-semibold text-gray-800">درگاه پرداخت</p>
                    <p class="text-xs text-gray-500">انتقال به درگاه بانکی امن</p>
                  </div>
                </div>
                <i data-feather="shield"></i>
              </label>

              <label class="flex items-center justify-between gap-4 p-3 rounded-2xl border border-gray-200 hover:border-primary transition">
                <div class="flex items-center gap-3">
                  <input type="radio" name="pay-method" value="cod" class="accent-rose-500">
                  <div>
                    <p class="font-semibold text-gray-800">پرداخت در محل</p>
                    <p class="text-xs text-gray-500">پرداخت هنگام تحویل سفارش</p>
                  </div>
                </div>
                <i data-feather="truck"></i>
              </label>
            </div>
          </div>

          <!-- Card form removed -->

          <div class="flex gap-3">
            <a href="#/address" class="btn-secondary">
              <i data-feather="arrow-right"></i>
              بازگشت به آدرس
            </a>
            <button id="pay-now" class="btn-primary">
              پرداخت و ثبت سفارش
              <i data-feather="check-circle"></i>
            </button>
          </div>
        </div>

        <!-- Summary -->
        <aside class="space-y-6" data-aos="fade-up" data-aos-delay="100">
          <div class="profile-card">
            <h3 class="text-xl font-bold text-gray-800 mb-5">خلاصه سفارش</h3>
            <div class="mt-2 space-y-3 text-sm">
              <div class="flex items-center justify-between">
                <span class="text-gray-600">جمع جزء</span>
                <span id="pay-subtotal" class="font-bold text-gray-800">۰ تومان</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-gray-600">تخفیف</span>
                <span id="pay-discount" class="font-bold text-rose-700">۰ تومان</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-gray-600">هزینه ارسال</span>
                <span id="pay-shipping" class="font-bold text-gray-800">۰ تومان</span>
              </div>
              <div class="border-t pt-3 flex items-center justify-between text-base">
                <span class="font-extrabold text-gray-900">مبلغ قابل پرداخت</span>
                <span id="pay-grand" class="font-extrabold text-gray-900">۰ تومان</span>
              </div>
            </div>
          </div>

          <div class="profile-card">
            <h4 class="font-bold text-gray-800 mb-3">ارسال به:</h4>
            <p id="pay-ship-to" class="text-sm text-gray-600 leading-7">—</p>
          </div>
        </aside>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer id="about" class="bg-gradient-to-b from-gray-900 to-black text-white py-20">
    <div class="container mx-auto px-6">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-12 mb-12">
        <div class="lg:col-span-2">
          <h3 class="text-3xl font-serif font-bold mb-6">KOALAW</h3>
          <p class="text-gray-400 mb-6 leading-relaxed">ارتقای زیبایی از طریق تجمل آگاهانه. هر محصول جشنی از بهترین مواد طبیعی و علم نوآورانه است.</p>
          <div class="space-y-3 mb-8">
            <div class="flex items-start gap-2 text-gray-300"><i data-feather="map-pin" class="w-5 h-5 flex-shrink-0 mt-0.5"></i>
              <address class="not-italic leading-relaxed">ایران، همدان، بلوار معدنی</address>
            </div>
            <div class="rounded-xl overflow-hidden ring-1 ring-white/10 max-w-sm">
              <iframe title="Iran Hamedan Madani Blvd Map" src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d13076.699965851406!2d48.51733694002674!3d34.97746897368537!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3fee6d4d12658141%3A0x5514695c023923c4!2sMadani%20Blvd%2C%20Hamedan%2C%20Hamedan%20Province%2C%20Iran!5e0!3m2!1sen!2s!4v1701345678901!5m2!1sen!2s" width="100%" height="160" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
          </div>
          <div class="flex gap-3">
            <a href="#" class="bg-gray-800 p-3 rounded-full hover:bg-gray-700 transition-all duration-300 transform hover:scale-110"><i data-feather="instagram" class="w-5 h-5"></i></a>
          </div>
        </div>
        <div id="footer-links" class="lg:col-span-3 grid grid-cols-2 md:grid-cols-3 gap-8"></div>
      </div>
      <div class="border-t border-gray-800 pt-8">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="flex flex-col md:flex-row items-center mb-4 md:mb-0">
            <p class="text-gray-400 text-sm mb-2 md:mb-0 md:ml-6">© ۲۰۲۵ D.AI — تمام حقوق محفوظ است.</p>
            <div class="flex items-center gap-x-6 md:gap-x-8 text-sm flex-wrap">
              <a href="#" class="text-gray-400 hover:text-white transition duration-300">سیاست حفظ حریم خصوصی</a>
              <a href="#" class="text-gray-400 hover:text-white transition duration-300">شرایط خدمات</a>
              <a href="#" class="text-gray-400 hover:text-white transition duration-300">سیاست کوکی</a>
            </div>
          </div>
          <div class="flex items-center gap-x-4">
            <span class="text-gray-400 text-sm ml-2">پرداخت امن:</span>
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg" alt="Visa" class="h-8 opacity-70 hover:opacity-100 transition-opacity duration-300">
            <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" alt="Mastercard" class="h-8 opacity-70 hover:opacity-100 transition-opacity duration-300">
            <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal" class="h-6 opacity-70 hover:opacity-100 transition-opacity duration-300">
            <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg" alt="Apple Pay" class="h-8 opacity-70 hover:opacity-100 transition-opacity duration-300">
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Search Overlay -->
  <div id="search-overlay" class="search-overlay">
    <div class="search-container">
      <button id="close-search-button" class="close-search-button"><i data-feather="x" class="w-8 h-8"></i></button>
      <form class="search-form" onsubmit="event.preventDefault()">
        <input type="search" id="search-input" placeholder="جستجو برای محصولات، برندها و..." class="search-input">
        <button type="submit" class="search-submit-button"><i data-feather="search"></i></button>
      </form>
      <div class="search-suggestions">
        <p>پیشنهادات:</p>
        <a href="/shop?query=serum">سرم پوست</a>
        <a href="/shop?query=matte">رژ لب مات</a>
        <a href="/shop?query=perfume">عطر</a>
        <a href="/shop?query=foundation">کرم پودر</a>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">
    <i data-feather="check-circle"></i>
    <span id="toast-text">انجام شد</span>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      AOS.init({ duration: 600, easing: "ease-out-cubic", once: true, offset: 40 });
      feather.replace();

      // Footer links
      (function(){
        const fLC = document.getElementById("footer-links");
        const fL = {
          "فروشگاه": ["تازه‌ها", "پرفروش‌ترین‌ها", "مراقبت از پوست", "آرایش", "عطر", "ست‌های هدیه"],
          "خدمات مشتریان": ["تماس با ما", "سوالات متداول", "اطلاعات ارسال", "مرجوعی", "پیگیری سفارش"]
        };
        for (const t in fL) {
          let l = "";
          fL[t].forEach(it => l += `<li><a href="#" class="text-gray-400 hover:text-white transition duration-300">${it}</a></li>`);
          fLC.innerHTML += `<div><h4 class="font-semibold text-lg mb-6">${t}</h4><ul class="space-y-3">${l}</ul></div>`;
        }
      })();

      // Mobile menu
      (function(){
        const mB = document.getElementById('mobile-menu-button'),
              mM = document.getElementById('mobile-menu'),
              mO = document.getElementById('mobile-menu-overlay');
        const toggleMenu = () => {
          mB.classList.toggle('is-active');
          mM.classList.toggle('is-active');
          mO.classList.toggle('is-active');
          document.body.classList.toggle('mobile-menu-open');
        };
        mB?.addEventListener('click', toggleMenu);
        mO?.addEventListener('click', toggleMenu);
        mM?.querySelectorAll('a').forEach(a => a.addEventListener('click', () => {
          if (mM.classList.contains('is-active')) toggleMenu();
        }));
      })();

      // Search overlay
      (function(){
        const searchButton = document.getElementById('search-button'),
              searchOverlay = document.getElementById('search-overlay'),
              closeSearchButton = document.getElementById('close-search-button'),
              searchInput = document.getElementById('search-input');
        const openSearch = () => { searchOverlay.classList.add('is-active'); document.body.classList.add('search-overlay-open'); setTimeout(()=>searchInput?.focus(), 400); };
        const closeSearch = () => { searchOverlay.classList.remove('is-active'); document.body.classList.remove('search-overlay-open'); };
        searchButton?.addEventListener('click', e => { e.preventDefault(); openSearch(); });
        closeSearchButton?.addEventListener('click', closeSearch);
        searchOverlay?.addEventListener('click', e => { if (e.target === searchOverlay) closeSearch(); });
        document.addEventListener('keydown', e => { if (e.key === 'Escape' && searchOverlay?.classList.contains('is-active')) closeSearch(); });
      })();

      // Navbar scroll effect
      (function(){
        const nav = document.getElementById("navbar");
        let lastY = 0;
        window.addEventListener("scroll", () => {
          const y = window.pageYOffset;
          nav.style.background = y > 100 ? "rgba(250,248,243,.95)" : "rgba(250,248,243,.85)";
          nav.style.boxShadow = y > 100 ? "0 4px 30px rgba(0,0,0,.1)" : "0 1px 20px rgba(0,0,0,.05)";
          nav.style.transform = (y > lastY && y > 500) ? "translateY(-100%)" : "translateY(0)";
          lastY = y;
        });
      })();

      // Cursor
      (function(){
        const cur = document.querySelector(".cursor"),
              cF = document.querySelector(".cursor-face"),
              cFol = document.querySelector(".cursor-follower");
        let cX=0,cY=0,fX=0,fY=0,s=.5;
        if (window.innerWidth > 768){
          document.addEventListener("mousemove", e => { cX=e.clientX; cY=e.clientY; });
          (function loop(){ cur.style.left=cX+"px"; cur.style.top=cY+"px"; cF.style.left=cX+"px"; cF.style.top=cY+"px"; fX+=(cX-fX)*s; fY+=(cY-fY)*s; cFol.style.left=fX+"px"; cFol.style.top=fY+"px"; requestAnimationFrame(loop) })();
          document.querySelectorAll("a,button,input,textarea,.order-card,.profile-card,.qty-btn").forEach(el=>{
            el.addEventListener("mouseenter",()=>{ cur.classList.add("hover"); cFol.style.transform="translate(-50%,-50%) scale(1.5)"; });
            el.addEventListener("mouseleave",()=>{ cur.classList.remove("hover"); cFol.style.transform="translate(-50%,-50%) scale(1)"; });
          });
        } else { [cur,cF,cFol].forEach(e=>e.style.display="none"); }
      })();

      // Floating hearts
      (function () {
        if (!window.matchMedia("(prefers-reduced-motion:reduce)").matches)
          document.addEventListener("click", e => {
            if (e.target.closest("input,textarea,select,button,a")) return;
            const t = document.createElement("span");
            t.className = "floating-heart";
            t.textContent = ["❤","✦","✧","❀","❣","★"][Math.floor(6*Math.random())];
            t.style.left = e.clientX + "px";
            t.style.top = e.clientY + "px";
            t.style.color = ["#f7bcd6","#c9c2ff","#bcefe1","#ffe3a4","#ffcfe0","#d6f0ff"][Math.floor(6*Math.random())];
            t.style.transform += ` rotate(${30*Math.random() - 15}deg)`;
            document.body.appendChild(t);
            setTimeout(()=>t.remove(), 1300);
          }, { passive: true });
      })();

      // Toast
      const toast = document.getElementById('toast');
      const toastText = document.getElementById('toast-text');
      function showToast(msg, icon='check-circle'){
        toastText.textContent = msg;
        toast.querySelector('svg')?.remove();
        const i = document.createElement('i');
        i.setAttribute('data-feather', icon);
        toast.insertBefore(i, toastText);
        feather.replace();
        toast.classList.add('show');
        setTimeout(()=>toast.classList.remove('show'), 2200);
      }

      // Store + state
      const CART_KEY='koalaw_cart';
      const STATE_KEY='koalaw_cart_state';
      const ADDR_KEY='koalaw_checkout_address';
      const LAST_ORDER_KEY='koalaw_last_order';

      const FREE_SHIP_THRESHOLD=1000000; // 1,000,000
      const BASE_SHIPPING=45000;
      const EXPRESS_PRICE=30000;
      const GIFT_WRAP_PRICE=20000;

      const coupons = {
        'KOALAW10': { type:'percent', value:10, min:0, msg:'کد ۱۰٪ تخفیف اعمال شد.' },
        'WELCOME15': { type:'percent', value:15, min:400000, msg:'۱۵٪ تخفیف خوش‌آمدگویی اعمال شد.' },
        'FREESHIP': { type:'shipping', value:BASE_SHIPPING, min:0, msg:'ارسال رایگان فعال شد.' },
      };

      const SAMPLE_ITEMS = [
        { id:'p-100', title:'اکسیر درخشش طلایی', price:480000, qty:1, image:'./image/product.png', variant:'30ml' },
        { id:'p-200', title:'رژ لب بوسه مخملی', price:320000, qty:2, image:'./image/cosmetic.png', variant:'Shade 03' },
      ];
      const RECS = [
        { id:'r-1', title:'سرم هیالورونیک', price:290000, image:'./image/skin.png' },
        { id:'r-2', title:'عطر راز نیمه‌شب', price:780000, image:'./image/perfume.png' },
        { id:'r-3', title:'ماسک مو تغذیه‌کننده', price:350000, image:'./image/hair.png' },
        { id:'r-4', title:'رژ گونه لطیف', price:260000, image:'./image/cosmetic.png' },
      ];

      function toIRR(n){ return (n<=0?0:n).toLocaleString('fa-IR')+' تومان'; }
      function toFa(n){ return n.toLocaleString('fa-IR'); }

      function loadCart(){
        try{
          const raw = localStorage.getItem(CART_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) return parsed;
          }
        }catch(e){}
        localStorage.setItem(CART_KEY, JSON.stringify(SAMPLE_ITEMS));
        return [...SAMPLE_ITEMS];
      }
      function saveCart(cart){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }

      function loadState(){
        try{
          const raw = localStorage.getItem(STATE_KEY);
          if (raw) return JSON.parse(raw);
        }catch(e){}
        const init = { coupon:'', gift:false, express:false, note:'', shippingMethod:'standard', payMethod:'gateway' };
        localStorage.setItem(STATE_KEY, JSON.stringify(init));
        return init;
      }
      function saveState(state){ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }

      function loadAddress(){
        try{
          const raw = localStorage.getItem(ADDR_KEY);
          if (raw) return JSON.parse(raw);
        }catch(e){}
        return { firstname:'', lastname:'', phone:'', postal:'', province:'', city:'', line1:'' };
      }
      function saveAddress(addr){ localStorage.setItem(ADDR_KEY, JSON.stringify(addr)); }

      // Shared compute totals
      function computeTotals(cart, state){
        const subtotal = cart.reduce((a,c)=>a + (c.price*c.qty), 0);
        let discount=0, shipping=0, gift= state.gift ? GIFT_WRAP_PRICE : 0;
        if (state.coupon){
          const r = coupons[state.coupon.toUpperCase()];
          if (r && subtotal >= r.min){
            if (r.type === 'percent') discount = Math.floor(subtotal*(r.value/100));
            else if (r.type === 'shipping') shipping = 0;
          }
        }
        const postSubtotal = subtotal - discount;
        if (postSubtotal >= FREE_SHIP_THRESHOLD) shipping = 0;
        else shipping = BASE_SHIPPING;
        if (state.express) shipping += EXPRESS_PRICE;
        const total = Math.max(0, postSubtotal + shipping + gift);
        return { subtotal, discount, shipping, gift, total };
      }

      // UI helpers
      function showProcessing(text='در حال پردازش...'){
        let ov = document.getElementById('pay-processing-overlay');
        if (!ov){
          ov = document.createElement('div');
          ov.id = 'pay-processing-overlay';
          ov.className = 'fixed inset-0 z-[120] bg-black/50 backdrop-blur-sm flex items-center justify-center';
          ov.innerHTML = `
            <div class="bg-white rounded-2xl px-6 py-5 shadow-xl text-center">
              <div class="mx-auto mb-3 w-10 h-10 border-4 border-rose-300 border-t-transparent rounded-full animate-spin"></div>
              <p class="font-bold text-gray-800" id="pay-processing-text"></p>
            </div>`;
          document.body.appendChild(ov);
        }
        ov.querySelector('#pay-processing-text').textContent = text;
        ov.style.display = 'flex';
      }
      function hideProcessing(){
        const ov = document.getElementById('pay-processing-overlay');
        if (ov) ov.style.display = 'none';
      }
      function setButtonLoading(btn, loading, label='در حال پردازش...'){
        if (loading){
          btn.dataset.orig = btn.innerHTML;
          btn.innerHTML = `<span class="inline-flex items-center gap-2"><span class="w-4 h-4 rounded-full border-2 border-white/40 border-l-white animate-spin"></span>${label}</span>`;
          btn.disabled = true;
          btn.classList.add('opacity-80','cursor-not-allowed');
        } else {
          if (btn.dataset.orig) btn.innerHTML = btn.dataset.orig;
          btn.disabled = false;
          btn.classList.remove('opacity-80','cursor-not-allowed');
          feather.replace();
        }
      }

      // Navigation / Router
      const routes = ['cart','address','payment'];
      function getRoute(){
        const h = location.hash.replace('#/','').trim();
        return routes.includes(h) ? h : 'cart';
      }
      function navigate(to){ location.hash = `#/${to}`; }

      // Hero content
      const heroMap = {
        cart: { icon:'shopping-bag', badge:'سبد خرید', title:'سفارش خود را نهایی کنید', sub:'بررسی اقلام سبد، اعمال کد تخفیف و ادامه به پرداخت' },
        address: { icon:'map-pin', badge:'آدرس و ارسال', title:'نشانی و روش ارسال خود را انتخاب کنید', sub:'اطلاعات تحویل را وارد کنید و ادامه دهید' },
        payment: { icon:'credit-card', badge:'پرداخت', title:'پرداخت و ثبت سفارش', sub:'به درگاه بانکی امن هدایت می‌شوید' },
      };
      function updateHero(route){
        const meta = heroMap[route];
        document.getElementById('hero-badge').textContent = meta.badge;
        document.getElementById('hero-title').textContent = meta.title;
        document.getElementById('hero-subtitle').textContent = meta.sub;
        const icon = document.getElementById('hero-icon');
        icon.setAttribute('data-feather', meta.icon);
        icon.replaceWith(icon.cloneNode(false));
        feather.replace();
      }

      function updateStepper(route, cart, addr){
        const index = routes.indexOf(route);
        const sc = document.getElementById('step-cart');
        const sa = document.getElementById('step-address');
        const sp = document.getElementById('step-payment');
        [sc,sa,sp].forEach(s=>{ s.classList.remove('is-done','is-current'); s.removeAttribute('aria-disabled'); });

        if (index === 0){ sc.classList.add('is-current'); }
        if (index === 1){ sc.classList.add('is-done'); sa.classList.add('is-current'); }
        if (index === 2){ sc.classList.add('is-done'); sa.classList.add('is-done'); sp.classList.add('is-current'); }

        const hasCart = cart.length > 0;
        const addrValid = validateAddress(addr);
        if (!hasCart){
          sa.setAttribute('aria-disabled','true'); sp.setAttribute('aria-disabled','true');
        } else if (!addrValid){
          sp.setAttribute('aria-disabled','true');
        }

        // Auto-center current step on small screens
        const stepsWrap = document.querySelector('.checkout-steps');
        if (window.innerWidth < 640 && stepsWrap){
          const current = stepsWrap.querySelector('.step.is-current');
          current?.scrollIntoView({ behavior:'smooth', inline:'center', block:'nearest' });
        }
      }

      // Views rendering
      function renderCart(){
        const cart = loadCart();
        let state = loadState();
        document.getElementById('cart-express').checked = !!state.express;
        document.getElementById('cart-gift-wrap').checked = !!state.gift;
        document.getElementById('cart-note').value = state.note || '';
        document.getElementById('cart-coupon-code').value = state.coupon || '';
        document.getElementById('cart-coupon-msg').textContent = state.coupon ? (coupons[state.coupon]?.msg || 'کد اعمال‌شده.') : '';

        document.getElementById('nav-cart-count').textContent = toFa(cart.reduce((a,c)=>a+c.qty,0));

        const itemsWrap = document.getElementById('cart-items');
        const empty = document.getElementById('cart-empty');
        itemsWrap.innerHTML = '';
        if (!cart.length){
          empty.classList.remove('hidden');
        } else {
          empty.classList.add('hidden');
          cart.forEach(line=>{
            const row = document.createElement('div');
            row.className = 'order-card';
            row.dataset.id = line.id;
            row.innerHTML = `
              <div class="flex gap-4 items-center">
                <div class="w-24 h-24 rounded-xl overflow-hidden bg-rose-50 flex-shrink-0">
                  <img src="${line.image}" alt="${line.title}" class="w-full h-full object-cover"/>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-start justify-between gap-4">
                    <div class="min-w-0">
                      <h4 class="font-bold text-gray-800 truncate">${line.title}</h4>
                      <div class="text-xs text-gray-500 mt-1">${line.variant || '—'}</div>
                      <div class="mt-2 inline-flex items-center gap-2 text-rose-700 text-sm font-bold">
                        <i data-feather="credit-card"></i>
                        <span>${toIRR(line.price)}</span>
                      </div>
                    </div>
                    <button class="remove text-rose-600 hover:text-rose-800 p-2 rounded-lg bg-rose-50 hover:bg-rose-100 transition" title="حذف">
                      <i data-feather="trash-2"></i>
                    </button>
                  </div>
                  <div class="mt-3 flex items-center justify-between gap-3 flex-wrap">
                    <div class="qty-box">
                      <button class="qty-btn minus" title="کاهش"><i data-feather="minus"></i></button>
                      <input class="qty-input" type="number" min="1" value="${line.qty}">
                      <button class="qty-btn plus" title="افزایش"><i data-feather="plus"></i></button>
                    </div>
                    <div class="text-sm text-gray-600">
                      مبلغ این آیتم:
                      <span class="font-extrabold text-gray-900" data-line-total>${toIRR(line.price*line.qty)}</span>
                    </div>
                  </div>
                </div>
              </div>
            `;
            itemsWrap.appendChild(row);
          });
        }
        feather.replace();

        // Attach handlers for lines
        itemsWrap.querySelectorAll('.qty-btn.plus').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.closest('[data-id]').dataset.id;
            const i = cart.findIndex(x=>x.id===id);
            if (i>-1){ cart[i].qty++; saveCart(cart); renderCart(); }
          });
        });
        itemsWrap.querySelectorAll('.qty-btn.minus').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.closest('[data-id]').dataset.id;
            const i = cart.findIndex(x=>x.id===id);
            if (i>-1){ cart[i].qty = Math.max(1, cart[i].qty-1); saveCart(cart); renderCart(); }
          });
        });
        itemsWrap.querySelectorAll('.qty-input').forEach(inp=>{
          inp.addEventListener('input', ()=>{
            const row = inp.closest('[data-id]');
            const id = row.dataset.id;
            const i = cart.findIndex(x=>x.id===id);
            let v = parseInt(inp.value||'1',10);
            if (isNaN(v) || v<1) v=1;
            if (i>-1){ cart[i].qty = v; saveCart(cart); row.querySelector('[data-line-total]').textContent = toIRR(cart[i].price*cart[i].qty); updateCartSummary(); }
          });
        });
        itemsWrap.querySelectorAll('.remove').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.closest('[data-id]').dataset.id;
            const newCart = cart.filter(x=>x.id!==id);
            saveCart(newCart); showToast('آیتم حذف شد','trash-2'); renderCart();
          });
        });

        // Summary + progress
        function updateCartSummary(){
          const s = loadState(); const c = loadCart();
          const t = computeTotals(c, s);
          document.getElementById('cart-subtotal').textContent = toIRR(t.subtotal);
          document.getElementById('cart-discount').textContent = t.discount>0 ? `- ${toIRR(t.discount)}` : '۰ تومان';
          document.getElementById('cart-shipping').textContent = t.shipping===0 ? 'رایگان' : toIRR(t.shipping);
          document.getElementById('cart-gift').textContent = s.gift? toIRR(t.gift) : '۰ تومان';
          document.getElementById('cart-grand').textContent = toIRR(t.total);

          const current = Math.max(0, t.subtotal - t.discount);
          if (current >= FREE_SHIP_THRESHOLD){
            document.getElementById('cart-progress-text').textContent = 'تبریک! ارسال رایگان برای سفارش شما فعال شد.';
            document.getElementById('cart-ship-badge').textContent = 'ارسال رایگان';
            document.getElementById('cart-ship-badge').className = 'text-xs px-3 py-1 rounded-full badge-free';
            document.getElementById('cart-progress-bar').style.width = '100%';
          } else {
            const remain = FREE_SHIP_THRESHOLD - current;
            document.getElementById('cart-progress-text').textContent = `برای ارسال رایگان، هنوز ${toIRR(remain)} مانده است.`;
            document.getElementById('cart-ship-badge').textContent = 'فعال‌سازی ارسال رایگان';
            document.getElementById('cart-ship-badge').className = 'text-xs px-3 py-1 rounded-full badge-warn';
            const pct = Math.min(100, Math.round((current / FREE_SHIP_THRESHOLD) * 100));
            document.getElementById('cart-progress-bar').style.width = pct + '%';
          }
        }
        updateCartSummary();

        // Options
        document.getElementById('cart-gift-wrap').onchange = (e)=>{
          state.gift = e.target.checked; saveState(state); updateCartSummary();
        };
        document.getElementById('cart-express').onchange = (e)=>{
          state.express = e.target.checked; state.shippingMethod = state.express ? 'express' : 'standard'; saveState(state); updateCartSummary();
        };
        document.getElementById('cart-note').oninput = (e)=>{
          state.note = e.target.value; saveState(state);
        };

        // Coupon
        document.getElementById('cart-apply-coupon').onclick = ()=>{
          const code = (document.getElementById('cart-coupon-code').value || '').trim().toUpperCase();
          const msgEl = document.getElementById('cart-coupon-msg');
          const subtotal = cart.reduce((a,c)=>a+c.price*c.qty,0);
          if (!code){ state.coupon=''; saveState(state); msgEl.textContent=''; updateCartSummary(); return; }
          const r = coupons[code];
          if (r){
            if (subtotal < r.min){
              msgEl.textContent = `حداقل سبد برای این کد: ${toIRR(r.min)}`;
              msgEl.className = 'text-sm text-rose-700 mt-2';
            } else {
              state.coupon = code; saveState(state);
              msgEl.textContent = r.msg || 'کد تخفیف اعمال شد.'; msgEl.className='text-sm text-emerald-700 mt-2';
              showToast('کد تخفیف اعمال شد','tag'); updateCartSummary();
            }
          } else { msgEl.textContent = 'کد معتبر نیست.'; msgEl.className = 'text-sm text-rose-700 mt-2'; }
        };

        // Clear cart
        document.getElementById('cart-clear').onclick = ()=>{
          if (!cart.length) return;
          if (confirm('آیا از پاک کردن سبد خرید مطمئن هستید؟')){
            saveCart([]); renderCart();
          }
        };

        // Recommendations (both mobile/tablet and desktop)
        const recWraps = document.querySelectorAll('#cart-recommendations, #cart-recommendations-desktop');
        recWraps.forEach(recWrap => {
          recWrap.innerHTML = '';
          RECS.forEach(p=>{
            const d = document.createElement('button');
            d.className = "text-right p-3 rounded-xl border hover:border-rose-300 bg-white transition";
            d.innerHTML = `
              <div class="aspect-square rounded-lg overflow-hidden mb-2 bg-rose-50">
                <img src="${p.image}" alt="${p.title}" class="w-full h-full object-cover"/>
              </div>
              <div class="text-sm font-bold text-gray-800 truncate">${p.title}</div>
              <div class="text-xs text-gray-600 mt-1">${toIRR(p.price)}</div>
              <div class="mt-2 inline-flex items-center gap-1 text-rose-700 text-xs">
                <i data-feather="plus-circle"></i>
                افزودن
              </div>
            `;
            d.addEventListener('click', ()=>{
              const c = loadCart();
              const i = c.findIndex(x=>x.id===p.id);
              if (i>-1) c[i].qty += 1; else c.push({ id:p.id, title:p.title, price:p.price, qty:1, image:p.image, variant:'' });
              saveCart(c); showToast('به سبد اضافه شد','check-circle'); renderCart();
            });
            recWrap.appendChild(d);
          });
        });
        feather.replace();

        // Checkout -> address
        document.getElementById('cart-checkout-btn').onclick = ()=>{
          if (!loadCart().length){ showToast('سبد خرید خالی است','alert-circle'); navigate('cart'); return; }
          navigate('address');
        };
      }

      function validateAddress(a){
        return !!(a.firstname && a.lastname && a.phone && a.province && a.city && a.line1);
      }

      function renderAddress(){
        const cart = loadCart();
        if (!cart.length){ showToast('ابتدا محصولی به سبد اضافه کنید','alert-triangle'); navigate('cart'); return; }

        let state = loadState();
        let addr = loadAddress();

        // Prefill
        const ids = ['firstname','lastname','phone','postal','province','city','line1'];
        ids.forEach(k=>{
          const el = document.getElementById('addr-'+k);
          if (el) el.value = addr[k] || '';
          el?.addEventListener('input', ()=>{
            addr[k] = el.value.trim();
            saveAddress(addr);
            updateAddrSummary();
          });
        });

        // Shipping method sync
        const std = document.getElementById('addr-ship-standard');
        const exp = document.getElementById('addr-ship-express');
        std.checked = !state.express;
        exp.checked = !!state.express;

        document.getElementById('addr-price-standard').textContent = toIRR(BASE_SHIPPING);
        document.getElementById('addr-price-express').textContent = toIRR(BASE_SHIPPING + EXPRESS_PRICE);

        document.querySelectorAll('input[name="addr-ship"]').forEach(r=>{
          r.onchange = ()=>{
            state.express = (r.value==='express');
            state.shippingMethod = state.express ? 'express' : 'standard';
            saveState(state); updateAddrSummary();
          };
        });

        // Summary
        function updateAddrSummary(){
          const t = computeTotals(loadCart(), loadState());
          document.getElementById('addr-subtotal').textContent = toIRR(t.subtotal);
          document.getElementById('addr-discount').textContent = t.discount>0 ? `- ${toIRR(t.discount)}` : '۰ تومان';
          document.getElementById('addr-shipping').textContent = t.shipping===0 ? 'رایگان' : toIRR(t.shipping);
          document.getElementById('addr-grand').textContent = toIRR(t.total);
          const a = loadAddress();
          document.getElementById('addr-ship-to').textContent = a.firstname ? `${a.firstname} ${a.lastname} — ${a.phone}
${a.province}، ${a.city}، ${a.line1} — کد پستی: ${a.postal||'—'}` : '—';
          document.getElementById('nav-cart-count').textContent = toFa(loadCart().reduce((x,y)=>x+y.qty,0));
        }
        updateAddrSummary();
        feather.replace();

        // Continue to payment
        document.getElementById('addr-to-payment').onclick = ()=>{
          addr = loadAddress();
          if (!validateAddress(addr)){
            showToast('لطفاً اطلاعات آدرس را کامل کنید','alert-circle'); return;
          }
          navigate('payment');
        };
      }

      // Payment (Card form removed; redirect to gateway)
      function renderPayment(){
        const cart = loadCart();
        if (!cart.length){ showToast('سبد خرید خالی است','alert-circle'); navigate('cart'); return; }
        const addr = loadAddress();
        if (!validateAddress(addr)){ showToast('ابتدا آدرس را تکمیل کنید','alert-triangle'); navigate('address'); return; }

        let state = loadState();

        // Summary + ship-to
        function updatePaySummary(){
          const t = computeTotals(loadCart(), loadState());
          document.getElementById('pay-subtotal').textContent = toIRR(t.subtotal);
          document.getElementById('pay-discount').textContent = t.discount>0 ? `- ${toIRR(t.discount)}` : '۰ تومان';
          document.getElementById('pay-shipping').textContent = t.shipping===0 ? 'رایگان' : toIRR(t.shipping);
          document.getElementById('pay-grand').textContent = toIRR(t.total);
          const a = loadAddress();
          document.getElementById('pay-ship-to').textContent = `${a.firstname} ${a.lastname} — ${a.phone}
${a.province}، ${a.city}، ${a.line1} — کد پستی: ${a.postal||'—'}`;
          document.getElementById('nav-cart-count').textContent = toFa(loadCart().reduce((x,y)=>x+y.qty,0));
        }
        updatePaySummary();

        // Payment method toggle + persist
        const radios = Array.from(document.querySelectorAll('input[name="pay-method"]'));
        const savedMethod = state.payMethod || 'gateway';
        const rSaved = radios.find(r => r.value === savedMethod);
        if (rSaved) rSaved.checked = true; else (radios[0] && (radios[0].checked = true));

        function selectedMethod(){
          return document.querySelector('input[name="pay-method"]:checked')?.value || 'gateway';
        }
        radios.forEach(r=>{
          r.addEventListener('change', ()=>{
            state = loadState();
            state.payMethod = r.value;
            saveState(state);
          });
        });

        // Pay now (gateway redirect or COD)
        const payBtn = document.getElementById('pay-now');
        let locking = false;

        payBtn.onclick = ()=>{
          if (locking) return;
          const method = selectedMethod();
          state = loadState(); state.payMethod = method; saveState(state);

          if (method === 'gateway'){
            locking = true; setButtonLoading(payBtn, true, 'در حال انتقال به درگاه...'); showProcessing('در حال انتقال به درگاه بانکی...');
            setTimeout(()=>{
              showProcessing('بازگشت از درگاه...');
              setTimeout(()=>{
                hideProcessing();
                finishOrder('paid', { method:'gateway', authority: 'A' + Date.now().toString().slice(-8) });
                setButtonLoading(payBtn, false);
                locking = false;
              }, 1000);
            }, 900);
          } else { // COD
            finishOrder('cod', { method:'cod' });
          }
        };

        function finishOrder(status, payment){
          const totals = computeTotals(loadCart(), loadState());
          const order = {
            id: 'KL-' + Date.now(),
            at: new Date().toISOString(),
            items: loadCart().map(({id,title,price,qty,variant})=>({id,title,price,qty,variant})),
            addr: loadAddress(),
            note: loadState().note || '',
            coupon: loadState().coupon || '',
            shippingMethod: loadState().shippingMethod || 'standard',
            totals,
            payment: { status, ...payment }
          };
          localStorage.setItem(LAST_ORDER_KEY, JSON.stringify(order));
          saveCart([]);
          showToast('سفارش با موفقیت ثبت شد!','check-circle');
          navigate('cart');
        }

        feather.replace();
      }

      function renderRoute(){
        const route = getRoute();
        const cart = loadCart();
        const addr = loadAddress();

        // Toggle views
        document.getElementById('view-cart').classList.toggle('hidden', route!=='cart');
        document.getElementById('view-address').classList.toggle('hidden', route!=='address');
        document.getElementById('view-payment').classList.toggle('hidden', route!=='payment');

        updateHero(route);
        updateStepper(route, cart, addr);

        if (route==='cart') renderCart();
        if (route==='address') renderAddress();
        if (route==='payment') renderPayment();

        AOS.refresh();
      }

      // Stepper click gating
      ['step-cart','step-address','step-payment'].forEach(id=>{
        const el = document.getElementById(id);
        el.addEventListener('click', (e)=>{
          const to = el.id.replace('step-','');
          const cart = loadCart();
          const addr = loadAddress();
          if (to==='address' && !cart.length){ e.preventDefault(); showToast('ابتدا محصولی به سبد اضافه کنید','alert-triangle'); }
          if (to==='payment' && (!cart.length || !validateAddress(addr))){ e.preventDefault(); showToast('آدرس را تکمیل کنید','alert-triangle'); }
        });
      });

      // Init route
      if (!location.hash) navigate('cart');
      window.addEventListener('hashchange', renderRoute);
      renderRoute();
    });
  </script>
</body>
</html>