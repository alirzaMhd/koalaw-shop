<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تایید شماره | KOALAW</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

  <style>
    @import url("https://font-face.ir/css/iransans/");

    :root {
      --primary: #e39ab4;
      --secondary: #1a1a1a;
      --accent: #ffe9f2;
      --rose-gold: #f0b7c4;
      --rose-cream: #e3d1d6;
      --cream: #faf8f3;
      --deep-brown: #3d2914;
      --blush: #ffd7e5;
      --lavender: #eae2ff;
      --mint: #dff8ef;
      --butter: #fff3bf;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      cursor: none !important;
    }

    body {
      font-family: "IRANSans", sans-serif;
      font-size: 15px;
      background-color: var(--cream);
      color: #333;
      overflow-x: hidden;
      cursor: none;
    }

    .font-serif {
      font-family: "IRANSans", serif;
    }

    .cloud-animation,
    .particle-overlay {
      position: absolute;
      inset: 0;
      overflow: hidden;
    }

    .cloud-animation {
      z-index: 5;
    }

    .cloud {
      position: absolute;
      background: radial-gradient(ellipse at center, rgba(227, 154, 180, 0.8) 0, transparent 70%);
      border-radius: 100%;
      opacity: 0;
      filter: blur(30px);
      animation: float-cloud linear infinite;
      will-change: transform, opacity;
    }

    .cloud-1 {
      width: 600px;
      height: 200px;
      top: 10%;
      left: -300px;
      animation-duration: 8s;
      animation-delay: 0s;
    }

    .cloud-2 {
      width: 800px;
      height: 250px;
      top: 30%;
      left: -400px;
      animation-duration: 12s;
      animation-delay: 2s;
    }

    .cloud-3 {
      width: 500px;
      height: 180px;
      top: 50%;
      left: -250px;
      animation-duration: 10s;
      animation-delay: 4s;
    }

    .cloud-4 {
      width: 700px;
      height: 220px;
      top: 70%;
      left: -350px;
      animation-duration: 12s;
      animation-delay: 2s;
    }

    .cloud-5 {
      width: 550px;
      height: 190px;
      top: 20%;
      left: -275px;
      animation-duration: 12s;
      animation-delay: 8s;
    }

    .cloud-6 {
      width: 450px;
      height: 170px;
      top: 85%;
      left: -225px;
      animation-duration: 8s;
      animation-delay: 2s;
    }

    @keyframes float-cloud {
      0% {
        transform: translateX(0) translateY(0);
        opacity: 0;
      }

      10%,
      90% {
        opacity: 0.9;
      }

      100% {
        transform: translateX(calc(100vw + 800px)) translateY(-30px);
        opacity: 0;
      }
    }

    .particle-overlay {
      z-index: 6;
      pointer-events: none;
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 50%;
      animation: float-particle linear infinite;
      filter: blur(1px);
    }

    @keyframes float-particle {
      0% {
        transform: translateY(100vh) rotate(0);
        opacity: 0;
      }

      10%,
      90% {
        opacity: 1;
      }

      100% {
        transform: translateY(-10vh) rotate(360deg);
        opacity: 0;
      }
    }

    @media (prefers-reduced-motion: reduce) {

      .cloud,
      .particle {
        animation: none !important;
      }
    }

    .cursor {
      width: 30px;
      height: 30px;
      border: 2px solid #666;
      background: 0 0;
      border-radius: 50% 50% 45% 45%;
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      transform: translate(-50%, -50%);
      transition: border-color 0.2s ease, transform 0.2s ease;
    }

    .cursor::after,
    .cursor::before {
      content: "";
      position: absolute;
      width: 12px;
      height: 12px;
      border: 2px solid #666;
      background: 0 0;
      border-radius: 50%;
      top: -3px;
      transition: border-color 0.2s ease;
    }

    .cursor::before {
      right: -9px;
    }

    .cursor::after {
      left: -9px;
    }

    .cursor-face {
      position: fixed;
      width: 30px;
      height: 30px;
      pointer-events: none;
      z-index: 10000;
      transform: translate(-50%, -50%);
    }

    .cursor-face::before {
      content: "";
      position: absolute;
      width: 4px;
      height: 7px;
      border: 1.5px solid #333;
      background: 0 0;
      border-radius: 50%;
      top: 13px;
      left: 50%;
      transform: translateX(-50%);
    }

    .cursor-eyes {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
    }

    .cursor-eyes::after,
    .cursor-eyes::before {
      content: "";
      position: absolute;
      width: 3px;
      height: 3px;
      border: 2px solid #333;
      background: 0 0;
      border-radius: 50%;
      top: 10px;
    }

    .cursor-eyes::before {
      right: 6px;
    }

    .cursor-eyes::after {
      left: 6px;
    }

    .cursor.hover {
      border-color: var(--primary);
      transform: translate(-50%, -50%) scale(1.2);
    }

    .cursor.hover::after,
    .cursor.hover::before {
      border-color: var(--primary);
    }

    .cursor-follower {
      width: 50px;
      height: 50px;
      background: rgba(227, 154, 180, 0.1);
      border-radius: 50%;
      position: fixed;
      pointer-events: none;
      z-index: 9998;
      transform: translate(-50%, -50%);
      transition: background 0.3s ease, transform 0.3s ease;
    }
  </style>
</head>

<body>
  <!-- Custom Cursor -->
  <div class="cursor">
    <div class="cursor-eyes"></div>
  </div>
  <div class="cursor-face"></div>
  <div class="cursor-follower"></div>

  <!-- Main -->
  <main class="min-h-screen w-full flex items-center justify-center p-4 relative overflow-hidden" style="background:linear-gradient(to bottom,#faf8f3,#fff7fb)">
    <div class="cloud-animation"></div>
    <div class="particle-overlay"></div>
    <div class="absolute inset-0 bg-gradient-to-t from-black/10 via-black/5 to-transparent z-0"></div>

    <div class="relative z-10 w-full max-w-md bg-white/70 backdrop-blur-xl rounded-3xl shadow-2xl shadow-rose-200/50 p-8 md:p-12 text-center space-y-6" data-aos="fade-up" data-aos-duration="700">
      <!-- Logo -->
      <a href="#" class="text-3xl font-serif font-bold text-gray-800 tracking-wider z-50 flex items-center justify-center gap-x-1" dir="ltr">K<img src="./image/koala.png" alt="Koala logo" class="w-8 h-7 inline-block -mt-1">ALAW</a>

      <!-- Title -->
      <h1 class="text-2xl font-bold text-deep-brown">کد تایید را وارد کنید</h1>

      <!-- Subtitle -->
      <p class="text-gray-600" id="phoneInfo">
        کد ۶ رقمی به شماره شما ارسال شد.
      </p>

      <!-- OTP Inputs -->
      <form id="otpForm" class="space-y-6">
        <div class="flex items-center justify-center gap-2 sm:gap-3" dir="ltr">
          <input class="otp-input w-11 h-12 sm:w-12 sm:h-14 text-center text-xl sm:text-2xl rounded-xl border-2 border-rose-200/60 bg-cream/60 text-deep-brown focus:outline-none focus:ring-4 focus:ring-primary/30 focus:border-primary transition-all" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" autocomplete="one-time-code" />
          <input class="otp-input w-11 h-12 sm:w-12 sm:h-14 text-center text-xl sm:text-2xl rounded-xl border-2 border-rose-200/60 bg-cream/60 text-deep-brown focus:outline-none focus:ring-4 focus:ring-primary/30 focus:border-primary transition-all" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" />
          <input class="otp-input w-11 h-12 sm:w-12 sm:h-14 text-center text-xl sm:text-2xl rounded-xl border-2 border-rose-200/60 bg-cream/60 text-deep-brown focus:outline-none focus:ring-4 focus:ring-primary/30 focus:border-primary transition-all" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" />
          <input class="otp-input w-11 h-12 sm:w-12 sm:h-14 text-center text-xl sm:text-2xl rounded-xl border-2 border-rose-200/60 bg-cream/60 text-deep-brown focus:outline-none focus:ring-4 focus:ring-primary/30 focus:border-primary transition-all" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" />
          <input class="otp-input w-11 h-12 sm:w-12 sm:h-14 text-center text-xl sm:text-2xl rounded-xl border-2 border-rose-200/60 bg-cream/60 text-deep-brown focus:outline-none focus:ring-4 focus:ring-primary/30 focus:border-primary transition-all" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" />
          <input class="otp-input w-11 h-12 sm:w-12 sm:h-14 text-center text-xl sm:text-2xl rounded-xl border-2 border-rose-200/60 bg-cream/60 text-deep-brown focus:outline-none focus:ring-4 focus:ring-primary/30 focus:border-primary transition-all" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" />
        </div>

        <!-- Error/Info -->
        <p id="otpMsg" class="min-h-[20px] text-sm text-red-500"></p>

        <!-- Verify button -->
        <button id="btnVerify" type="submit" class="w-full px-8 py-4 bg-pink-500 text-white rounded-full font-semibold text-lg hover:shadow-2xl hover:shadow-pink-500/40 hover:bg-pink-600 transition-all duration-300 transform hover:-translate-y-1 disabled:opacity-60 disabled:cursor-not-allowed" disabled>
          تایید و ادامه
        </button>

        <!-- Resend -->
        <div class="text-sm text-gray-700 flex items-center justify-center gap-2">
          <span>کدی دریافت نکردید؟</span>
          <button type="button" id="btnResend" class="inline-flex items-center gap-1 font-semibold text-primary hover:underline disabled:text-gray-400 disabled:no-underline disabled:cursor-not-allowed" disabled>
            <i data-feather="refresh-ccw" class="w-4 h-4"></i>
            <span>ارسال مجدد کد</span>
          </button>
          <span id="resendTimer" class="text-gray-500">(۶۰ ثانیه)</span>
        </div>

        <!-- Change phone -->
        <div class="text-sm">
          <button type="button" id="editPhone" class="inline-flex items-center gap-1 font-semibold text-deep-brown hover:text-primary transition-colors">
            <i data-feather="edit-2" class="w-4 h-4"></i>
            ویرایش شماره
          </button>
        </div>
      </form>

      <!-- Back -->
      <div>
        <a href="/" class="inline-flex items-center gap-2 text-deep-brown font-semibold hover:text-primary transition-colors duration-300 group">
          <i data-feather="arrow-right" class="w-5 h-5 transition-transform duration-300 group-hover:translate-x-1"></i>
          <span>بازگشت به صفحه اصلی</span>
        </a>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Init AOS
      AOS.init({ duration: 600, easing: "ease-out-cubic", once: true, offset: 40 });

      // Background elements
      const cC = document.querySelector(".cloud-animation");
      const pC = document.querySelector(".particle-overlay");
      if (cC) { for (let i = 1; i <= 6; i++) cC.innerHTML += `<div class="cloud cloud-${i}"></div>`; }
      if (pC) { for (let i = 0; i < 9; i++) pC.innerHTML += `<div class="particle" style="left:${10 + 10 * i}%;animation-duration:${25 + 10 * Math.random()}s;animation-delay:${15 * Math.random()}s"></div>`; }

      // Icons
      feather.replace();

      // Custom cursor
      const cur = document.querySelector(".cursor");
      const cF = document.querySelector(".cursor-face");
      const cFol = document.querySelector(".cursor-follower");
      let cX = 0, cY = 0, fX = 0, fY = 0, s = .5;

      if (window.innerWidth > 768) {
        document.addEventListener("mousemove", e => { cX = e.clientX; cY = e.clientY; });
        function animateCursor() {
          cur.style.left = cX + "px"; cur.style.top = cY + "px";
          cF.style.left = cX + "px"; cF.style.top = cY + "px";
          fX += (cX - fX) * s; fY += (cY - fY) * s;
          cFol.style.left = fX + "px"; cFol.style.top = fY + "px";
          requestAnimationFrame(animateCursor);
        }
        animateCursor();
        document.querySelectorAll("a, button, input").forEach(el => {
          el.addEventListener("mouseenter", () => {
            cur.classList.add("hover");
            cFol.style.transform = "translate(-50%,-50%) scale(1.5)";
          });
          el.addEventListener("mouseleave", () => {
            cur.classList.remove("hover");
            cFol.style.transform = "translate(-50%,-50%) scale(1)";
          });
        });
      } else {
        [cur, cF, cFol].forEach(el => el.style.display = "none");
      }

      // Helpers
      const qs = s => document.querySelector(s);
      const qsa = s => Array.from(document.querySelectorAll(s));

      function normalizeIranPhone(p) {
        const d = (p || "").replace(/\D/g, "");
        if (d.startsWith("0098")) return "0" + d.slice(4);
        if (d.startsWith("98")) return "0" + d.slice(2);
        if (d.startsWith("0")) return d;
        if (d.startsWith("9")) return "0" + d;
        return p || "";
      }

      function maskPhone(p) {
        const n = normalizeIranPhone(p).replace(/\D/g, "");
        if (!n) return "";
        return n.replace(/\d(?=\d{4})/g, "•");
      }

      // Show phone (from URL or localStorage)
      const params = new URLSearchParams(location.search);
      const phoneRaw = params.get("phone") || localStorage.getItem("signup_phone") || "";
      const phoneMasked = phoneRaw ? maskPhone(phoneRaw) : "";
      const phoneInfo = qs("#phoneInfo");
      if (phoneMasked) {
        phoneInfo.textContent = `کد ۶ رقمی به شماره ${phoneMasked} ارسال شد.`;
      }

      // OTP handling
      const inputs = qsa(".otp-input");
      const form = qs("#otpForm");
      const btnVerify = qs("#btnVerify");
      const otpMsg = qs("#otpMsg");

      inputs[0].focus();

      function getCode() {
        return inputs.map(i => i.value).join("");
      }

      function updateVerifyState() {
        const filled = getCode().length === inputs.length;
        btnVerify.disabled = !filled;
        if (filled) otpMsg.textContent = "";
      }

      inputs.forEach((inp, idx) => {
        // Only digits
        inp.addEventListener("input", (e) => {
          const v = e.target.value.replace(/\D/g, "");
          e.target.value = v.slice(0, 1);
          if (v && idx < inputs.length - 1) inputs[idx + 1].focus();
          updateVerifyState();
        });

        // Backspace to previous
        inp.addEventListener("keydown", (e) => {
          if ((e.key === "Backspace" || e.key === "Delete") && !inp.value && idx > 0) {
            inputs[idx - 1].focus();
          }
          if (e.key === "ArrowLeft" && idx > 0) inputs[idx - 1].focus();
          if (e.key === "ArrowRight" && idx < inputs.length - 1) inputs[idx + 1].focus();
        });

        // Paste full code
        inp.addEventListener("paste", (e) => {
          const pasted = (e.clipboardData || window.clipboardData).getData("text").replace(/\D/g, "");
          if (!pasted) return;
          e.preventDefault();
          pasted.split("").slice(0, inputs.length).forEach((ch, i) => {
            inputs[i].value = ch;
          });
          inputs[Math.min(pasted.length, inputs.length) - 1]?.focus();
          updateVerifyState();
        });
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const code = getCode();

        if (code.length !== inputs.length) {
          otpMsg.textContent = "لطفاً کد ۶ رقمی را کامل وارد کنید.";
          return;
        }

        otpMsg.textContent = "";
        btnVerify.disabled = true;
        btnVerify.innerHTML = `<span class="inline-flex items-center justify-center gap-2">
          <svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="white" stroke-width="4"></circle>
            <path class="opacity-75" fill="white" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          در حال بررسی...
        </span>`;

        try {
          // TODO: Replace with real API call to verify code
          await new Promise(res => setTimeout(res, 1000));

          // Simulate success
          // Redirect or proceed
          window.location.href = "/"; // change to dashboard or next step
        } catch (err) {
          otpMsg.textContent = "خطا در تایید کد. دوباره تلاش کنید.";
          btnVerify.textContent = "تایید و ادامه";
          btnVerify.disabled = false;
        }
      });

      // Resend logic with countdown
      const btnResend = qs("#btnResend");
      const resendTimer = qs("#resendTimer");
      let timeLeft = 60;
      let tHandle;

      function tick() {
        timeLeft -= 1;
        if (timeLeft <= 0) {
          clearInterval(tHandle);
          btnResend.disabled = false;
          resendTimer.textContent = "";
          return;
        }
        resendTimer.textContent = `(${timeLeft} ثانیه)`;
      }

      function startTimer() {
        btnResend.disabled = true;
        timeLeft = 60;
        resendTimer.textContent = `(${timeLeft} ثانیه)`;
        clearInterval(tHandle);
        tHandle = setInterval(tick, 1000);
      }

      async function resendCode() {
        btnResend.disabled = true;
        // TODO: Call your API to resend code using phoneRaw
        // await fetch('/api/send-code', { method: 'POST', body: JSON.stringify({ phone: phoneRaw }) })
        await new Promise(res => setTimeout(res, 500));
        startTimer();
      }

      // Start initial countdown as if code was just sent
      startTimer();
      btnResend.addEventListener("click", resendCode);

      // Edit phone (go back)
      qs("#editPhone").addEventListener("click", () => {
        if (document.referrer) {
          history.back();
        } else {
          window.location.href = "/register.html";
        }
      });
    });
  </script>
</body>

</html>